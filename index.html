// Chargement initial
async function loadData() {
    document.getElementById('loadingIndicator').style.display = 'block'
    document.getElementById('emptyState').style.display = 'none'
    document.getElementById('controlTable').style.display = 'none'

    try {
        const { data, error } = await supabase
            .from('controles')
            .select('*')
            .order('processus', { ascending: true }) // tri principal
            .order('ordre', { ascending: true })    // tri secondaire

        if (error) throw error

        controles = data || []
        extractProcessus()        // Mettre Ã  jour la liste des processus
        renderTable()             // Afficher le tableau
        updateStats()             // Mettre Ã  jour les statistiques
        updateFilterOptions()     // Mettre Ã  jour les filtres

        document.getElementById('loadingIndicator').style.display = 'none'

        if (controles.length === 0) {
            document.getElementById('emptyState').style.display = 'block'
        } else {
            document.getElementById('controlTable').style.display = 'table'
        }

    } catch (err) {
        console.error(err)
        showError('Impossible de charger les donnÃ©es. VÃ©rifiez la connexion Supabase.')
        document.getElementById('loadingIndicator').style.display = 'none'
    }
}

// Extraire la liste des processus uniques
function extractProcessus() {
    const processusSet = new Set()
    controles.forEach(ctrl => {
        if (ctrl.processus) {
            processusSet.add(ctrl.processus)
        }
    })
    processus = Array.from(processusSet)
}

// Mettre Ã  jour les filtres des processus
function updateFilterOptions() {
    const select = document.getElementById('filterProcessus')
    select.innerHTML = '<option value="">Tous les processus</option>'
    processus.forEach(proc => {
        const option = document.createElement('option')
        option.value = proc
        option.textContent = proc
        select.appendChild(option)
    })
}

// Rendu du tableau
function renderTable() {
    const tbody = document.getElementById('tableBody')
    tbody.innerHTML = ''

    if (controles.length === 0) return

    let currentProcess = ''
    controles.forEach(ctrl => {
        // Ligne d'entÃªte pour chaque processus
        if (ctrl.processus !== currentProcess) {
            currentProcess = ctrl.processus
            const processControls = controles.filter(c => c.processus === currentProcess)
            const conformeCount = processControls.filter(c => c.statut === 'âœ”ï¸').length
            const totalCount = processControls.length
            const allConforme = conformeCount === totalCount && totalCount > 0
            const statusClass = allConforme ? 'process-conforme' : 'process-non-conforme'
            const statusText = allConforme ? 'âœ”ï¸ Processus Conforme' : 'âŒ Processus Non Conforme'

            const headerRow = document.createElement('tr')
            headerRow.className = 'process-header'
            headerRow.innerHTML = `
                <td colspan="8">
                    <strong>${currentProcess}</strong> - Responsable: ${ctrl.responsable || 'Non dÃ©fini'}
                    <span class="process-status ${statusClass}">${statusText}</span>
                    <button class="btn btn-danger btn-sm" style="float: right;" onclick="deleteProcess('${currentProcess}')">ğŸ—‘ï¸ Supprimer processus</button>
                </td>
            `
            tbody.appendChild(headerRow)
        }

        // Ligne de contrÃ´le
        const row = document.createElement('tr')
        row.className = 'control-row'
        row.dataset.id = ctrl.id
        row.dataset.processus = ctrl.processus
        row.dataset.statut = ctrl.statut

        const isConforme = ctrl.statut === 'âœ”ï¸'
        const statusClass = isConforme ? 'status-conforme' : 'status-non-conforme'
        const commentPreview = ctrl.commentaire 
            ? (ctrl.commentaire.length > 40 ? ctrl.commentaire.substring(0, 40) + '...' : ctrl.commentaire)
            : ''

        row.innerHTML = `
            <td><strong>${ctrl.controle || 'Sans nom'}</strong></td>
            <td>${ctrl.description || ''}</td>
            <td>${ctrl.responsable || ''}</td>
            <td>${ctrl.frequence || 'N/A'}</td>
            <td><span class="status-badge ${statusClass}" onclick="toggleStatus('${ctrl.id}')">${ctrl.statut}</span></td>
            <td onclick="updateDate('${ctrl.id}')" style="cursor: pointer;">${ctrl.date_verification || 'N/A'}</td>
            <td>
                <span class="comment-icon" onclick="openCommentModal('${ctrl.id}')">ğŸ’¬</span>
                <span class="comment-preview">${commentPreview}</span>
            </td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-primary btn-sm" onclick="editControl('${ctrl.id}')">âœï¸</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteControl('${ctrl.id}')">ğŸ—‘ï¸</button>
                </div>
            </td>
        `
        tbody.appendChild(row)
    })
}

// Appeler le chargement au dÃ©marrage
loadData()
