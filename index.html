<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des contr√¥les</title>
    <!-- Remplacez SUPABASE_URL et SUPABASE_ANON_KEY par les v√¥tres -->
    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    </script>
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .action-btn {
            margin-right: 5px;
            cursor: pointer;
        }
        .edit-btn { color: blue; }
        .delete-btn { color: red; }
        .status-btn {
            font-size: 16px;
            padding: 4px 8px;
            border: none;
            background: none;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        #addButton {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<h1>Gestion des contr√¥les</h1>
<button id="addButton">Ajouter un contr√¥le</button>
<table>
    <thead>
        <tr>
            <th>Processus</th>
            <th>Contr√¥le</th>
            <th>Description</th>
            <th>Responsable</th>
            <th>Fr√©quence</th>
            <th>Statut</th>
            <th>Date de v√©rification</th>
            <th>Commentaire</th>
            <th>Ordre</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="controlsTableBody">
        <!-- Les donn√©es seront ins√©r√©es ici dynamiquement -->
    </tbody>
</table>

<!-- Modal Ajout -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddModal()">&times;</span>
        <h2>Ajouter un contr√¥le</h2>
        <form id="addForm">
            <label>Processus:<br><input type="text" id="addProcessus" required></label><br>
            <label>Contr√¥le:<br><input type="text" id="addControle" required></label><br>
            <label>Description:<br><textarea id="addDescription" required></textarea></label><br>
            <label>Responsable:<br><input type="text" id="addResponsable" required></label><br>
            <label>Fr√©quence:<br><input type="text" id="addFrequence" required></label><br>
            <label>Statut:<br><input type="text" id="addStatut" required></label><br>
            <label>Date de v√©rification:<br><input type="date" id="addDateVerification"></label><br>
            <label>Commentaire:<br><textarea id="addCommentaire"></textarea></label><br>
            <label>Ordre:<br><input type="number" id="addOrdre" required></label><br><br>
            <button type="button" onclick="addControl()">Enregistrer</button>
        </form>
    </div>
</div>

<!-- Modal √âdition -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Modifier le contr√¥le</h2>
        <form id="editForm">
            <input type="hidden" id="editId">
            <label>Processus:<br><input type="text" id="editProcessus" required></label><br>
            <label>Contr√¥le:<br><input type="text" id="editControle" required></label><br>
            <label>Description:<br><textarea id="editDescription" required></textarea></label><br>
            <label>Responsable:<br><input type="text" id="editResponsable" required></label><br>
            <label>Fr√©quence:<br><input type="text" id="editFrequence" required></label><br>
            <label>Statut:<br><input type="text" id="editStatut" required></label><br>
            <label>Date de v√©rification:<br><input type="date" id="editDateVerification"></label><br>
            <label>Commentaire:<br><textarea id="editCommentaire"></textarea></label><br>
            <label>Ordre:<br><input type="number" id="editOrdre" required></label><br><br>
            <button type="button" onclick="updateControl()">Mettre √† jour</button>
        </form>
    </div>
</div>

<!-- Modal Commentaire -->
<div id="commentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCommentModal()">&times;</span>
        <h2>Modifier le commentaire</h2>
        <form id="commentForm">
            <input type="hidden" id="commentId">
            <textarea id="commentText" rows="4" cols="50"></textarea><br><br>
            <button type="button" onclick="updateComment()">Enregistrer</button>
        </form>
    </div>
</div>

<script>
    // Initialiser le client Supabase
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener('DOMContentLoaded', function() {
        loadControls();
        document.getElementById('addButton').addEventListener('click', openAddModal);
    });

    // Charger les donn√©es depuis Supabase et remplir le tableau
    async function loadControls() {
        const { data, error } = await supabase
            .from('controles')
            .select('*')
            .order('ordre', { ascending: true });
        const tbody = document.getElementById('controlsTableBody');
        tbody.innerHTML = '';
        if (data) {
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.processus || ''}</td>
                    <td>${item.controle || ''}</td>
                    <td>${item.description || ''}</td>
                    <td>${item.responsable || ''}</td>
                    <td>${item.frequence || ''}</td>
                    <td><button class="status-btn" onclick="toggleStatus('${item.id}')">${item.statut === '‚úîÔ∏è' ? '‚úîÔ∏è' : '‚ùå'}</button></td>
                    <td onclick="updateDate('${item.id}')">${item.date_verification ? item.date_verification : ''}</td>
                    <td>${item.commentaire || ''} <button class="action-btn edit-btn" title="Modifier commentaire" onclick="openCommentModal('${item.id}')">‚úé</button></td>
                    <td>${item.ordre != null ? item.ordre : ''}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="openEditModal('${item.id}')">‚úé</button>
                        <button class="action-btn delete-btn" onclick="deleteControl('${item.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // Ouvrir le modal d'ajout
    function openAddModal() {
        document.getElementById('addModal').style.display = 'block';
    }
    function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
    }
    async function openEditModal(id) {
        // R√©cup√©rer les donn√©es du contr√¥le depuis Supabase
        const { data, error } = await supabase
            .from('controles')
            .select('*')
            .eq('id', id)
            .single();
        if (error) {
            console.error('Erreur de chargement du contr√¥le:', error.message);
        } else if (data) {
            document.getElementById('editId').value = data.id;
            document.getElementById('editProcessus').value = data.processus || '';
            document.getElementById('editControle').value = data.controle || '';
            document.getElementById('editDescription').value = data.description || '';
            document.getElementById('editResponsable').value = data.responsable || '';
            document.getElementById('editFrequence').value = data.frequence || '';
            document.getElementById('editStatut').value = data.statut || '';
            document.getElementById('editDateVerification').value = data.date_verification || '';
            document.getElementById('editCommentaire').value = data.commentaire || '';
            document.getElementById('editOrdre').value = data.ordre != null ? data.ordre : '';
            document.getElementById('editModal').style.display = 'block';
        }
    }
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }
    async function openCommentModal(id) {
        const { data, error } = await supabase
            .from('controles')
            .select('commentaire')
            .eq('id', id)
            .single();
        if (error) {
            console.error('Erreur de chargement du commentaire:', error.message);
        } else if (data) {
            document.getElementById('commentId').value = id;
            document.getElementById('commentText').value = data.commentaire || '';
            document.getElementById('commentModal').style.display = 'block';
        }
    }
    function closeCommentModal() {
        document.getElementById('commentModal').style.display = 'none';
    }

    // Ajouter un contr√¥le
    async function addControl() {
        const processus = document.getElementById('addProcessus').value;
        const controle = document.getElementById('addControle').value;
        const description = document.getElementById('addDescription').value;
        const responsable = document.getElementById('addResponsable').value;
        const frequence = document.getElementById('addFrequence').value;
        const statut = document.getElementById('addStatut').value;
        const date_verification = document.getElementById('addDateVerification').value || null;
        const commentaire = document.getElementById('addCommentaire').value;
        const ordre = parseInt(document.getElementById('addOrdre').value);
        const { data, error } = await supabase
            .from('controles')
            .insert([{ processus, controle, description, responsable, frequence, statut, date_verification, commentaire, ordre }]);
        if (error) {
            console.error('Erreur d\'ajout:', error.message);
        } else {
            closeAddModal();
            loadControls();
        }
    }

    // Mettre √† jour un contr√¥le
    async function updateControl() {
        const id = document.getElementById('editId').value;
        const processus = document.getElementById('editProcessus').value;
        const controle = document.getElementById('editControle').value;
        const description = document.getElementById('editDescription').value;
        const responsable = document.getElementById('editResponsable').value;
        const frequence = document.getElementById('editFrequence').value;
        const statut = document.getElementById('editStatut').value;
        const date_verification = document.getElementById('editDateVerification').value || null;
        const commentaire = document.getElementById('editCommentaire').value;
        const ordre = parseInt(document.getElementById('editOrdre').value);
        const { data, error } = await supabase
            .from('controles')
            .update({ processus, controle, description, responsable, frequence, statut, date_verification, commentaire, ordre })
            .eq('id', id);
        if (error) {
            console.error('Erreur de mise √† jour:', error.message);
        } else {
            closeEditModal();
            loadControls();
        }
    }

    // Supprimer un contr√¥le
    async function deleteControl(id) {
        if (confirm('Voulez-vous vraiment supprimer ce contr√¥le ?')) {
            const { data, error } = await supabase
                .from('controles')
                .delete()
                .eq('id', id);
            if (error) {
                console.error('Erreur de suppression:', error.message);
            } else {
                loadControls();
            }
        }
    }

    // Mettre √† jour le statut (‚úîÔ∏è / ‚ùå)
    async function toggleStatus(id) {
        const { data: currentData, error: currentError } = await supabase
            .from('controles')
            .select('statut')
            .eq('id', id)
            .single();
        if (currentError) {
            console.error('Erreur de r√©cup√©ration du statut:', currentError.message);
            return;
        }
        const newStatus = currentData.statut === '‚úîÔ∏è' ? '‚ùå' : '‚úîÔ∏è';
        const { error } = await supabase
            .from('controles')
            .update({ statut: newStatus })
            .eq('id', id);
        if (error) {
            console.error('Erreur de mise √† jour du statut:', error.message);
        } else {
            loadControls();
        }
    }

    // Modifier le commentaire via modal
    async function updateComment() {
        const id = document.getElementById('commentId').value;
        const commentaire = document.getElementById('commentText').value;
        const { data, error } = await supabase
            .from('controles')
            .update({ commentaire: commentaire })
            .eq('id', id);
        if (error) {
            console.error('Erreur de mise √† jour du commentaire:', error.message);
        } else {
            closeCommentModal();
            loadControls();
        }
    }

    // Mettre √† jour la date de v√©rification √† aujourd'hui
    async function updateDate(id) {
        const today = new Date().toISOString().split('T')[0];
        const { data, error } = await supabase
            .from('controles')
            .update({ date_verification: today })
            .eq('id', id);
        if (error) {
            console.error('Erreur de mise √† jour de la date:', error.message);
        } else {
            loadControls();
        }
    }
</script>

</body>
</html>
