<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Grille de Contr√¥le Op√©rationnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Ton CSS existant (inchang√©) */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height:100vh; }
        .container { max-width: 1800px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:30px; text-align:center; position:relative; }
        .header h1 { font-size:28px; margin-bottom:10px; }
        .header p { font-size:14px; opacity:0.9; }
        .save-indicator { position:absolute; top:20px; right:30px; padding:8px 16px; border-radius:20px; font-size:13px; font-weight:600; background:rgba(255,255,255,0.2); }
        .save-indicator.saving { background:#ffc107; color:#000; }
        .save-indicator.saved { background:#28a745; color:white; }
        .save-indicator.error { background:#dc3545; color:white; }
        /* ... (le reste de ton CSS reste identique) ... */
    </style>
</head>
<body>
<div class="container">
    <!-- Header + Controls + Stats + Table + Modals restent identiques -->
    <div class="header">
        <h1>üìä Grille de Contr√¥le Op√©rationnel</h1>
        <p>Syst√®me de gestion et de suivi des contr√¥les internes</p>
        <span class="save-indicator" id="saveIndicator"></span>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="openAddProcessModal()">‚ûï Nouveau Processus</button>
        <button class="btn btn-primary" onclick="openAddControlModal()">‚ûï Nouveau Contr√¥le</button>
        <button class="btn btn-success" onclick="exportToExcel()">üì• Export Excel</button>
        <button class="btn btn-warning" onclick="toggleStats()">üìà Statistiques</button>
        <div class="filter-group">
            <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="filterTable()">
            <select id="filterProcessus" onchange="filterTable()">
                <option value="">Tous les processus</option>
            </select>
            <select id="filterStatut" onchange="filterTable()">
                <option value="">Tous les statuts</option>
                <option value="‚úîÔ∏è">Conforme</option>
                <option value="‚ùå">Non conforme</option>
                <option value="‚Ä¶">En attente</option>
            </select>
        </div>
    </div>

    <div class="stats" id="statsSection" style="display:none;">
        <div class="stat-card"><div class="stat-label">Total Processus</div><div class="stat-value" id="totalProcessus">0</div></div>
        <div class="stat-card"><div class="stat-label">Total Contr√¥les</div><div class="stat-value" id="totalControles">0</div></div>
        <div class="stat-card"><div class="stat-label">Contr√¥les Conformes</div><div class="stat-value" style="color:#28a745;" id="conformes">0</div></div>
        <div class="stat-card"><div class="stat-label">Non Conformes</div><div class="stat-value" style="color:#dc3545;" id="nonConformes">0</div></div>
        <div class="stat-card"><div class="stat-label">Taux de Conformit√©</div><div class="stat-value" style="color:#667eea;" id="tauxConformite">0%</div></div>
    </div>

    <div id="errorContainer"></div>

    <div class="table-container">
        <div id="loadingIndicator" class="loading">‚è≥ Chargement des donn√©es...</div>
        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="empty-state-icon">üìã</div>
            <h3>Aucun contr√¥le pour le moment</h3>
            <p>Commencez par cr√©er un nouveau processus ou un nouveau contr√¥le</p><br>
            <button class="btn btn-primary" onclick="openAddProcessModal()">‚ûï Cr√©er un processus</button>
        </div>

        <table id="controlTable" style="display:none;">
            <thead>
                <tr>
                    <th style="width:180px;">Processus / Contr√¥le</th>
                    <th style="width:200px;">Description</th>
                    <th style="width:120px;">Responsable</th>
                    <th style="width:100px;">Fr√©quence</th>
                    <th style="width:100px;">Statut</th>
                    <th style="width:100px;">Date V√©rif.</th>
                    <th style="width:200px;">Commentaires</th>
                    <th style="width:120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modals (identiques) -->
<!-- ... ton HTML pour modals ... -->

<script>
    // ----------- Supabase Setup -----------
    const SUPABASE_URL = "https://bcwbyugpjlwrpvbbgajg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60";
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ----------- State -----------
    let controles = [];
    let processus = [];
    let currentCommentId = null;
    let currentEditId = null;

    // ----------- Utils (inchang√©s) -----------
    function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
    function escapeHtml(str) { if (!str) return ''; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;") }
    function showSaveIndicator(status) { const indicator = document.getElementById('saveIndicator'); indicator.className = 'save-indicator ' + status; if(status==='saving') indicator.textContent='üíæ Sauvegarde...'; else if(status==='saved'){indicator.textContent='‚úÖ Sauvegard√©'; setTimeout(()=>{indicator.className='save-indicator'; indicator.textContent=''},1200)} else if(status==='error'){indicator.textContent='‚ùå Erreur'; setTimeout(()=>{indicator.className='save-indicator'; indicator.textContent=''},2000)} }
    function showError(message) { const container=document.getElementById('errorContainer'); container.innerHTML=`<div class="error">‚ö†Ô∏è ${escapeHtml(message)}</div>`; setTimeout(()=>{ container.innerHTML=''; },5000) }

    // ----------- Supabase CRUD -----------
    async function loadData() {
        document.getElementById('loadingIndicator').style.display = 'block';
        try {
            const { data, error } = await supabase.from('controles').select('*');
            if(error) throw error;
            controles = data.map(c => ({
                id: c.id,
                processus: c.processus,
                controle: c.controle,
                description: c.description,
                responsable: c.responsable,
                frequence: c.frequence,
                statut: c.statut,
                commentaire: c.commentaire,
                date_verification: c.date_verification
            }));
            processus = Array.from(new Set(controles.map(c => c.processus)));
            renderTable(controles);
            updateFilterOptions();
            updateStats();
            document.getElementById('loadingIndicator').style.display='none';
            document.getElementById('emptyState').style.display=controles.length===0?'block':'none';
            document.getElementById('controlTable').style.display=controles.length===0?'none':'table';
        } catch(e) {
            showError(e.message);
        }
    }

    async function saveProcessSupabase(procName, respName) {
        const { data, error } = await supabase.from('processus').insert([{ nom: procName, responsable: respName }]);
        if(error) throw error;
        processus.push(procName);
        updateFilterOptions();
        updateStats();
    }

    async function saveControlSupabase(ctrl) {
        showSaveIndicator('saving');
        try {
            if(ctrl.id){ // update
                const { error } = await supabase.from('controles').update({
                    processus: ctrl.processus,
                    controle: ctrl.controle,
                    description: ctrl.description,
                    responsable: ctrl.responsable,
                    frequence: ctrl.frequence,
                    statut: ctrl.statut,
                    commentaire: ctrl.commentaire,
                    date_verification: ctrl.date_verification
                }).eq('id', ctrl.id);
                if(error) throw error;
            } else { // insert
                const { data, error } = await supabase.from('controles').insert([ctrl]);
                if(error) throw error;
                ctrl.id = data[0].id;
            }
            showSaveIndicator('saved');
            await loadData();
        } catch(e) {
            showSaveIndicator('error');
            showError(e.message);
        }
    }

    async function deleteControlSupabase(id) {
        const { error } = await supabase.from('controles').delete().eq('id', id);
        if(error) showError(error.message);
        await loadData();
    }

    async function deleteProcessSupabase(procName) {
        const { error } = await supabase.from('controles').delete().eq('processus', procName);
        if(error) showError(error.message);
        processus = processus.filter(p => p!==procName);
        await loadData();
    }

    // ----------- Overwrite saveControl / delete / toggleStatus -----------

    async function saveProcess() {
        const nom = document.getElementById('processNom').value.trim()
        const responsable = document.getElementById('processResponsable').value.trim()
        if(!nom) return showError('Le nom du processus est requis.');
        try {
            await saveProcessSupabase(nom,responsable);
            showSaveIndicator('saved');
        } catch(e){ showSaveIndicator('error'); showError(e.message); }
        closeAddProcessModal();
    }

    async function saveControl() {
        const ctrl = {
            id: currentEditId || null,
            processus: document.getElementById('controlProcessus').value.trim(),
            controle: document.getElementById('controlNom').value.trim(),
            description: document.getElementById('controlDescription').value.trim(),
            responsable: document.getElementById('controlResponsable').value.trim(),
            frequence: document.getElementById('controlFrequence').value,
            statut: '‚ùå',
            commentaire: '',
            date_verification: ''
        };
        if(!ctrl.processus) return showError('Veuillez s√©lectionner un processus.');
        if(!ctrl.controle) return showError('Le nom du contr√¥le est requis.');
        if(!ctrl.responsable) return showError('Le responsable est requis.');
        await saveControlSupabase(ctrl);
        closeAddControlModal();
    }

    window.deleteControl = async function(id) { if(confirm('Supprimer ce contr√¥le ?')) await deleteControlSupabase(id) }
    window.deleteProcess = async function(procName) { if(confirm(`Supprimer tous les contr√¥les du processus "${procName}" ?`)) await deleteProcessSupabase(procName) }

    window.toggleStatus = async function(id) {
        const ctrl = controles.find(c => c.id===id);
        if(!ctrl) return;
        if(ctrl.statut==='‚ùå'||!ctrl.statut) ctrl.statut='‚Ä¶'; else if(ctrl.statut==='‚Ä¶') ctrl.statut='‚úîÔ∏è'; else ctrl.statut='‚ùå';
        await saveControlSupabase(ctrl);
    }

    window.updateDate = async function(id){
        const ctrl = controles.find(c => c.id===id);
        if(!ctrl) return;
        ctrl.date_verification=new Date().toISOString().split('T')[0];
        await saveControlSupabase(ctrl);
    }

    window.saveComment = async function() {
        if(!currentCommentId) return closeCommentModal();
        const ctrl = controles.find(c => c.id===currentCommentId);
        if(!ctrl) return closeCommentModal();
        ctrl.commentaire=document.getElementById('commentText').value;
        await saveControlSupabase(ctrl);
        closeCommentModal();
    }

    // ----------- Init -----------
    window.onload = loadData;

</script>
</body>
</html>
