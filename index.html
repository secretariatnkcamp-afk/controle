<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Test Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #2563eb; }
        .btn-success { background: #10b981; }
        .btn-danger { background: #ef4444; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background: #3b82f6;
            color: white;
        }
        .data-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        code {
            background: #f1f1f1;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Connexion Supabase</h1>
        
        <div class="status info" id="status">
            Pr√™t √† tester la connexion...
        </div>
        
        <div>
            <button class="btn" onclick="testConnection()">üîó Tester la connexion</button>
            <button class="btn" onclick="createTables()">üìä Cr√©er les tables</button>
            <button class="btn" onclick="addSampleData()">‚ûï Ajouter donn√©es test</button>
            <button class="btn btn-success" onclick="loadData()">üì• Charger donn√©es</button>
            <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Effacer donn√©es test</button>
        </div>
        
        <h3>Informations de connexion :</h3>
        <p><strong>URL :</strong> <code>https://bcwbyugpjlwrpvbbgajg.supabase.co</code></p>
        <p><strong>Cl√© publique :</strong> <code>sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60</code></p>
        
        <div id="results"></div>
        
        <h3>Donn√©es de la table "controles" :</h3>
        <div id="dataContainer">
            <p>Aucune donn√©e charg√©e</p>
        </div>
        
        <h3>Logs :</h3>
        <div id="logs" style="background: #f1f1f1; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://bcwbyugpjlwrpvbbgajg.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60';
        
        let supabase = null;
        
        // Initialisation
        function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('Client Supabase initialis√©');
                updateStatus('üü¢ Client Supabase initialis√©', 'success');
            } catch (error) {
                log('‚ùå Erreur initialisation: ' + error.message);
                updateStatus('‚ùå Erreur initialisation', 'error');
            }
        }
        
        // Tester la connexion
        async function testConnection() {
            log('Test de connexion...');
            updateStatus('‚è≥ Test de connexion en cours...', 'info');
            
            try {
                // Test simple - on essaye de lister les tables
                const { data, error } = await supabase
                    .from('controles')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('does not exist')) {
                        updateStatus('‚ö†Ô∏è Connexion OK mais table "controles" n\'existe pas', 'info');
                        log('Table "controles" non trouv√©e - il faut la cr√©er');
                    } else {
                        updateStatus('‚ùå Erreur: ' + error.message, 'error');
                        log('Erreur d√©taill√©e: ' + JSON.stringify(error));
                    }
                } else {
                    updateStatus('‚úÖ Connexion r√©ussie √† Supabase!', 'success');
                    log('Connexion r√©ussie!');
                }
            } catch (error) {
                updateStatus('‚ùå Erreur connexion: ' + error.message, 'error');
                log('Exception: ' + error.message);
            }
        }
        
        // Cr√©er les tables
        async function createTables() {
            log('Cr√©ation des tables...');
            updateStatus('‚è≥ Cr√©ation des tables...', 'info');
            
            try {
                // Cr√©er la table processus
                const { error: error1 } = await supabase.rpc('exec_sql', {
                    sql: `
                        CREATE TABLE IF NOT EXISTS processus (
                            id BIGSERIAL PRIMARY KEY,
                            nom TEXT UNIQUE NOT NULL,
                            created_at TIMESTAMP DEFAULT NOW()
                        );
                    `
                }).catch(async () => {
                    // Si la RPC n'existe pas, on essaie directement
                    const { error } = await supabase
                        .from('processus')
                        .select('count')
                        .limit(1);
                    
                    if (error && error.message.includes('does not exist')) {
                        log('Table "processus" n\'existe pas - cr√©ation n√©cessaire');
                        return { error: new Error('Table manquante') };
                    }
                    return { error: null };
                });
                
                // Cr√©er la table controles
                const { error: error2 } = await supabase.rpc('exec_sql', {
                    sql: `
                        CREATE TABLE IF NOT EXISTS controles (
                            id TEXT PRIMARY KEY,
                            processus TEXT NOT NULL,
                            controle TEXT NOT NULL,
                            description TEXT,
                            responsable TEXT NOT NULL,
                            frequence TEXT NOT NULL,
                            statut TEXT DEFAULT '‚ùå',
                            commentaire TEXT,
                            date_verification TEXT,
                            created_at TIMESTAMP DEFAULT NOW()
                        );
                    `
                }).catch(async () => {
                    const { error } = await supabase
                        .from('controles')
                        .select('count')
                        .limit(1);
                    
                    if (error && error.message.includes('does not exist')) {
                        log('Table "controles" n\'existe pas - cr√©ation n√©cessaire');
                        return { error: new Error('Table manquante') };
                    }
                    return { error: null };
                });
                
                // D√©sactiver RLS (Row Level Security)
                const { error: error3 } = await supabase.rpc('exec_sql', {
                    sql: `
                        ALTER TABLE processus DISABLE ROW LEVEL SECURITY;
                        ALTER TABLE controles DISABLE ROW LEVEL SECURITY;
                    `
                }).catch(() => {
                    log('Note: RPC exec_sql non disponible - RLS √† d√©sactiver manuellement');
                    return { error: null };
                });
                
                log('Instructions de cr√©ation envoy√©es');
                updateStatus('‚úÖ Instructions de cr√©ation envoy√©es. V√©rifiez dans Supabase SQL Editor.', 'success');
                
                // Afficher le code SQL √† ex√©cuter
                document.getElementById('results').innerHTML = `
                    <div class="status info">
                        <h4>Ex√©cutez ce code dans SQL Editor de Supabase :</h4>
                        <pre style="background: #f1f1f1; padding: 10px; border-radius: 5px; overflow-x: auto;">
-- Cr√©er les tables
CREATE TABLE IF NOT EXISTS processus (
    id BIGSERIAL PRIMARY KEY,
    nom TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS controles (
    id TEXT PRIMARY KEY,
    processus TEXT NOT NULL,
    controle TEXT NOT NULL,
    description TEXT,
    responsable TEXT NOT NULL,
    frequence TEXT NOT NULL,
    statut TEXT DEFAULT '‚ùå',
    commentaire TEXT,
    date_verification TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- D√©sactiver RLS (permissions)
ALTER TABLE processus DISABLE ROW LEVEL SECURITY;
ALTER TABLE controles DISABLE ROW LEVEL SECURITY;</pre>
                        <p><strong>Instructions :</strong></p>
                        <ol>
                            <li>Allez dans Supabase ‚Üí SQL Editor</li>
                            <li>Copiez-collez le code ci-dessus</li>
                            <li>Cliquez sur "Run"</li>
                            <li>Revenez ici et cliquez sur "Tester la connexion"</li>
                        </ol>
                    </div>
                `;
                
            } catch (error) {
                log('Erreur cr√©ation tables: ' + error.message);
                updateStatus('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Ajouter des donn√©es de test
        async function addSampleData() {
            log('Ajout donn√©es test...');
            
            try {
                // Ajouter quelques processus
                const processusData = [
                    { nom: 'Cycle Achats-Fournisseurs' },
                    { nom: 'Cycle Ventes-Clients' },
                    { nom: 'Cycle Tr√©sorerie' }
                ];
                
                for (const proc of processusData) {
                    const { error } = await supabase
                        .from('processus')
                        .upsert(proc, { onConflict: 'nom' });
                    
                    if (error) log('Erreur processus ' + proc.nom + ': ' + error.message);
                }
                
                // Ajouter des contr√¥les
                const controlesData = [
                    {
                        id: 'test1',
                        processus: 'Cycle Achats-Fournisseurs',
                        controle: '√âmission Bon de Commande',
                        description: 'V√©rifier validation selon seuils',
                        responsable: 'Sophie Martin',
                        frequence: 'Syst√©matique',
                        statut: '‚úîÔ∏è',
                        commentaire: 'Proc√©dure bien suivie',
                        date_verification: '2024-01-15'
                    },
                    {
                        id: 'test2',
                        processus: 'Cycle Achats-Fournisseurs',
                        controle: 'R√©ception marchandises',
                        description: 'Contr√¥le qualit√© √† la r√©ception',
                        responsable: 'Pierre Dubois',
                        frequence: 'Quotidien',
                        statut: '‚ùå',
                        commentaire: 'Manque de personnel',
                        date_verification: '2024-01-10'
                    },
                    {
                        id: 'test3',
                        processus: 'Cycle Ventes-Clients',
                        controle: 'Facturation',
                        description: 'V√©rifier concordance livraison/facturation',
                        responsable: 'Marie Laurent',
                        frequence: 'Hebdomadaire',
                        statut: '‚Ä¶',
                        commentaire: 'En cours d\'analyse',
                        date_verification: '2024-01-12'
                    }
                ];
                
                for (const ctrl of controlesData) {
                    const { error } = await supabase
                        .from('controles')
                        .upsert(ctrl, { onConflict: 'id' });
                    
                    if (error) log('Erreur contr√¥le ' + ctrl.id + ': ' + error.message);
                }
                
                log('Donn√©es test ajout√©es');
                updateStatus('‚úÖ Donn√©es test ajout√©es', 'success');
                
                // Recharger les donn√©es
                await loadData();
                
            } catch (error) {
                log('Erreur ajout donn√©es: ' + error.message);
                updateStatus('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Charger les donn√©es
        async function loadData() {
            log('Chargement donn√©es...');
            
            try {
                // Charger les contr√¥les
                const { data: controles, error } = await supabase
                    .from('controles')
                    .select('*')
                    .order('processus', { ascending: true });
                
                if (error) {
                    log('Erreur chargement: ' + error.message);
                    updateStatus('‚ùå Erreur chargement: ' + error.message, 'error');
                    return;
                }
                
                // Afficher les donn√©es
                if (controles && controles.length > 0) {
                    let html = '<table class="data-table">';
                    html += '<tr><th>ID</th><th>Processus</th><th>Contr√¥le</th><th>Responsable</th><th>Statut</th></tr>';
                    
                    controles.forEach(item => {
                        html += `<tr>
                            <td>${item.id}</td>
                            <td>${item.processus || ''}</td>
                            <td>${item.controle || ''}</td>
                            <td>${item.responsable || ''}</td>
                            <td>${item.statut || ''}</td>
                        </tr>`;
                    });
                    
                    html += '</table>';
                    html += `<p><strong>Total :</strong> ${controles.length} contr√¥le(s)</p>`;
                    
                    document.getElementById('dataContainer').innerHTML = html;
                    log(`${controles.length} contr√¥le(s) charg√©(s)`);
                    updateStatus(`‚úÖ ${controles.length} contr√¥le(s) charg√©(s)`, 'success');
                } else {
                    document.getElementById('dataContainer').innerHTML = 
                        '<p class="status info">Aucune donn√©e dans la table "controles"</p>';
                    log('Table "controles" vide');
                    updateStatus('üì≠ Table "controles" vide', 'info');
                }
                
            } catch (error) {
                log('Erreur: ' + error.message);
                updateStatus('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Effacer les donn√©es test
        async function clearData() {
            if (!confirm('Effacer toutes les donn√©es de test ?')) return;
            
            log('Effacement donn√©es test...');
            
            try {
                const { error: error1 } = await supabase
                    .from('controles')
                    .delete()
                    .like('id', 'test%');
                
                const { error: error2 } = await supabase
                    .from('processus')
                    .delete()
                    .in('nom', ['Cycle Achats-Fournisseurs', 'Cycle Ventes-Clients', 'Cycle Tr√©sorerie']);
                
                if (error1) log('Erreur effacement contr√¥les: ' + error1.message);
                if (error2) log('Erreur effacement processus: ' + error2.message);
                
                log('Donn√©es test effac√©es');
                updateStatus('üóëÔ∏è Donn√©es test effac√©es', 'info');
                
                // Recharger
                await loadData();
                
            } catch (error) {
                log('Erreur effacement: ' + error.message);
            }
        }
        
        // Fonctions utilitaires
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }
        
        function log(message) {
            const logsEl = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logsEl.innerHTML = `[${time}] ${message}<br>` + logsEl.innerHTML;
        }
        
        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
