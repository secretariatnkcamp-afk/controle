<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Grille de Contr√¥le Op√©rationnel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* Ici on garde ton CSS original (omitted pour la clart√©) */
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üìä Grille de Contr√¥le Op√©rationnel</h1>
        <p>Syst√®me de gestion et de suivi des contr√¥les internes</p>
        <span class="save-indicator" id="saveIndicator"></span>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="openAddProcessModal()">‚ûï Nouveau Processus</button>
        <button class="btn btn-primary" onclick="openAddControlModal()">‚ûï Nouveau Contr√¥le</button>
        <button class="btn btn-success" onclick="exportToExcel()">üì• Export Excel</button>
        <button class="btn btn-warning" onclick="toggleStats()">üìà Statistiques</button>
        <div class="filter-group">
            <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="filterTable()">
            <select id="filterProcessus" onchange="filterTable()">
                <option value="">Tous les processus</option>
            </select>
            <select id="filterStatut" onchange="filterTable()">
                <option value="">Tous les statuts</option>
                <option value="‚úîÔ∏è">Conforme</option>
                <option value="‚ùå">Non conforme</option>
            </select>
        </div>
    </div>

    <div class="stats" id="statsSection" style="display:none;">
        <div class="stat-card">
            <div class="stat-label">Total Processus</div>
            <div class="stat-value" id="totalProcessus">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Contr√¥les</div>
            <div class="stat-value" id="totalControles">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Contr√¥les Conformes</div>
            <div class="stat-value" style="color:#28a745;" id="conformes">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Non Conformes</div>
            <div class="stat-value" style="color:#dc3545;" id="nonConformes">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Taux de Conformit√©</div>
            <div class="stat-value" style="color:#667eea;" id="tauxConformite">0%</div>
        </div>
    </div>

    <div id="errorContainer"></div>

    <div class="table-container">
        <div id="loadingIndicator" class="loading">‚è≥ Chargement des donn√©es...</div>
        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="empty-state-icon">üìã</div>
            <h3>Aucun contr√¥le pour le moment</h3>
            <p>Commencez par cr√©er un nouveau processus ou un nouveau contr√¥le</p><br>
            <button class="btn btn-primary" onclick="openAddProcessModal()">‚ûï Cr√©er un processus</button>
        </div>

        <table id="controlTable" style="display:none;">
            <thead>
                <tr>
                    <th style="width:180px;">Processus / Contr√¥le</th>
                    <th style="width:200px;">Description</th>
                    <th style="width:120px;">Responsable</th>
                    <th style="width:100px;">Fr√©quence</th>
                    <th style="width:100px;">Statut</th>
                    <th style="width:100px;">Date V√©rif.</th>
                    <th style="width:200px;">Commentaires</th>
                    <th style="width:120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modals (commentaire, add process, add control) -->
<!-- Garder le m√™me HTML que ton code actuel pour les modals -->

<script>
    // ---------- Supabase ----------
    const SUPABASE_URL = 'https://<YOUR-PROJECT>.supabase.co'
    const SUPABASE_ANON_KEY = '<YOUR-ANON-KEY>'
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    let controles = []
    let processus = []
    let currentCommentId = null
    let currentEditId = null

    function showSaveIndicator(status) {
        const indicator = document.getElementById('saveIndicator')
        indicator.className = 'save-indicator ' + status
        if (status === 'saving') indicator.textContent = 'üíæ Sauvegarde...'
        else if (status === 'saved') {
            indicator.textContent = '‚úÖ Sauvegard√©'
            setTimeout(()=>{ indicator.className = 'save-indicator'; indicator.textContent = '' }, 1200)
        } else if (status === 'error') {
            indicator.textContent = '‚ùå Erreur'
            setTimeout(()=>{ indicator.className = 'save-indicator'; indicator.textContent = '' }, 2000)
        }
    }

    function showError(message) {
        const container = document.getElementById('errorContainer')
        container.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`
        setTimeout(()=>{ container.innerHTML = '' }, 5000)
    }

    // ---------- Load donn√©es Supabase ----------
    async function loadData() {
        document.getElementById('loadingIndicator').style.display = 'block'
        const { data, error } = await supabase.from('controles').select('*').order('ordre', {ascending:true})
        if (error) return showError(error.message)
        controles = data || []
        processus = Array.from(new Set(controles.map(c => c.processus)))
        renderTable(controles)
        updateStats()
        updateFilterOptions()
        document.getElementById('loadingIndicator').style.display = 'none'
        document.getElementById('emptyState').style.display = controles.length===0?'block':'none'
        document.getElementById('controlTable').style.display = controles.length===0?'none':'table'
    }

    // ---------- Save control (Supabase) ----------
    async function saveControl() {
        const processusVal = document.getElementById('controlProcessus').value.trim()
        const nom = document.getElementById('controlNom').value.trim()
        const desc = document.getElementById('controlDescription').value.trim()
        const resp = document.getElementById('controlResponsable').value.trim()
        const frequence = document.getElementById('controlFrequence').value

        if (!processusVal) return showError('Veuillez s√©lectionner un processus.')
        if (!nom) return showError('Le nom du contr√¥le est requis.')
        if (!resp) return showError('Le responsable est requis.')

        showSaveIndicator('saving')

        if (currentEditId) {
            const { error } = await supabase.from('controles').update({
                processus: processusVal,
                controle: nom,
                description: desc,
                responsable: resp,
                frequence: frequence
            }).eq('id', currentEditId)
            if (error) { showSaveIndicator('error'); return showError(error.message) }
        } else {
            const { error } = await supabase.from('controles').insert([{
                processus: processusVal,
                controle: nom,
                description: desc,
                responsable: resp,
                frequence: frequence,
                statut: '‚ùå',
                commentaire: '',
                date_verification: null
            }])
            if (error) { showSaveIndicator('error'); return showError(error.message) }
        }

        currentEditId = null
        closeAddControlModal()
        await loadData()
        showSaveIndicator('saved')
    }

    // ---------- Update statut ----------
    async function toggleStatus(id) {
        const ctrl = controles.find(c => c.id===id)
        if (!ctrl) return
        const newStatut = ctrl.statut==='‚ùå'?'‚úîÔ∏è':'‚ùå'
        const { error } = await supabase.from('controles').update({ statut: newStatut }).eq('id', id)
        if (error) return showError(error.message)
        await loadData()
    }

    // ---------- Update date ----------
    async function updateDate(id) {
        const today = new Date().toISOString().split('T')[0]
        const { error } = await supabase.from('controles').update({ date_verification: today }).eq('id', id)
        if (error) return showError(error.message)
        await loadData()
    }

    // ---------- Commentaire ----------
    async function saveComment() {
        if (!currentCommentId) return closeCommentModal()
        const texte = document.getElementById('commentText').value
        const { error } = await supabase.from('controles').update({ commentaire: texte }).eq('id', currentCommentId)
        if (error) return showError(error.message)
        closeCommentModal()
        await loadData()
    }

    // ---------- Delete ----------
    async function deleteControl(id) {
        if (!confirm('Voulez-vous vraiment supprimer ce contr√¥le ?')) return
        const { error } = await supabase.from('controles').delete().eq('id', id)
        if (error) return showError(error.message)
        await loadData()
    }

    async function deleteProcess(processName) {
        if (!confirm(`Supprimer tous les contr√¥les du processus "${processName}" ?`)) return
        const { error } = await supabase.from('controles').delete().eq('processus', processName)
        if (error) return showError(error.message)
        await loadData()
    }

    // ---------- Render Table (inchang√©) ----------
    function renderTable(list = controles) {
        const tbody = document.getElementById('tableBody')
        tbody.innerHTML = ''
        if (!list || list.length === 0) return
        let currentProcess = null
        const sorted = [...list].sort((a,b)=> (a.processus||'').localeCompare(b.processus||''))
        for (const ctrl of sorted) {
            if (ctrl.processus !== currentProcess) {
                currentProcess = ctrl.processus
                const processControls = sorted.filter(c => c.processus === currentProcess)
                const conformeCount = processControls.filter(c => c.statut==='‚úîÔ∏è').length
                const totalCount = processControls.length
                const allConforme = conformeCount===totalCount && totalCount>0
                const statusClass = allConforme?'process-conforme':'process-non-conforme'
                const statusText = allConforme?'‚úîÔ∏è Processus Conforme':'‚ùå Processus Non Conforme'
                const headerRow = document.createElement('tr')
                headerRow.className = 'process-header'
                headerRow.innerHTML = `
                    <td colspan="8">
                        <strong>${currentProcess}</strong>
                        <span class="process-status ${statusClass}">${statusText}</span>
                        <button class="btn btn-danger btn-sm" style="float:right;" onclick="deleteProcess(${JSON.stringify(currentProcess)})">üóëÔ∏è Supprimer processus</button>
                    </td>
                `
                tbody.appendChild(headerRow)
            }
            const isConforme = ctrl.statut==='‚úîÔ∏è'
            const statusClass = isConforme?'status-conforme':'status-non-conforme'
            const commentPreview = ctrl.commentaire ? (ctrl.commentaire.length>40?ctrl.commentaire.substring(0,40)+'...':ctrl.commentaire) : ''
            const row = document.createElement('tr')
            row.className='control-row'
            row.innerHTML=`
                <td><strong>${ctrl.controle||''}</strong></td>
                <td>${ctrl.description||''}</td>
                <td>${ctrl.responsable||''}</td>
                <td>${ctrl.frequence||''}</td>
                <td><span class="status-badge ${statusClass}" onclick="toggleStatus('${ctrl.id}')">${ctrl.statut||''}</span></td>
                <td onclick="updateDate('${ctrl.id}')" style="cursor:pointer;">${ctrl.date_verification||'N/A'}</td>
                <td>
                    <span class="comment-icon" onclick="openCommentModal('${ctrl.id}')">üí¨</span>
                    <span class="comment-preview">${commentPreview}</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editControl('${ctrl.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteControl('${ctrl.id}')">üóëÔ∏è</button>
                    </div>
                </td>
            `
            tbody.appendChild(row)
        }
    }

    // ---------- Stats ----------
    function updateStats() {
        const totalProcessusCount = Array.from(new Set(controles.map(c=>c.processus))).length
        const totalControlesCount = controles.length
        const conformesCount = controles.filter(c=>c.statut==='‚úîÔ∏è').length
        const nonConformesCount = controles.filter(c=>c.statut==='‚ùå').length
        const tauxConformite = totalControlesCount>0?Math.round(conformesCount/totalControlesCount*100):0
        document.getElementById('totalProcessus').textContent=totalProcessusCount
        document.getElementById('totalControles').textContent=totalControlesCount
        document.getElementById('conformes').textContent=conformesCount
        document.getElementById('nonConformes').textContent=nonConformesCount
        document.getElementById('tauxConformite').textContent=tauxConformite+'%'
    }

    function updateFilterOptions() {
        const select = document.getElementById('filterProcessus')
        select.innerHTML = '<option value="">Tous les processus</option>'
        Array.from(new Set(controles.map(c=>c.processus))).forEach(p=>{
            const option=document.createElement('option')
            option.value=p
            option.textContent=p
            select.appendChild(option)
        })
    }

    // ---------- Filtrage ----------
    function filterTable() {
        const q=document.getElementById('searchInput').value.toLowerCase()
        const procFilter=document.getElementById('filterProcessus').value
        const statFilter=document.getElementById('filterStatut').value
        const filtered=controles.filter(c=>{
            let ok=true
            if(procFilter) ok=ok && c.processus===procFilter
            if(statFilter) ok=ok && c.statut===statFilter
            if(q) ok=ok && `${c.processus||''} ${c.controle||''} ${c.description||''} ${c.responsable||''} ${c.commentaire||''}`.toLowerCase().includes(q)
            return ok
        })
        renderTable(filtered)
    }

    // ---------- Export Excel ----------
    function exportToExcel() {
        if(!controles.length) return showError('Aucun contr√¥le √† exporter.')
        const wsData = controles.map(c=>({
            Processus:c.processus, Controle:c.controle, Description:c.description,
            Responsable:c.responsable, Frequence:c.frequence, Statut:c.statut,
            Date_Verification:c.date_verification, Commentaire:c.commentaire
        }))
        const wb=XLSX.utils.book_new()
        const ws=XLSX.utils.json_to_sheet(wsData)
        XLSX.utils.book_append_sheet(wb,ws,'Controles')
        XLSX.writeFile(wb,'grille_controle_operationnel.xlsx')
    }

    // ---------- Init ----------
    loadData()
</script>
</body>
</html>
