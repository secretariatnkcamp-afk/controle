<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grille de Contr√¥le Op√©rationnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .save-indicator {
            position: absolute;
            top: 20px;
            right: 30px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
        }

        .save-indicator.saving {
            background: #ffc107;
            color: #000;
        }

        .save-indicator.saved {
            background: #28a745;
            color: white;
        }

        .save-indicator.error {
            background: #dc3545;
            color: white;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-group select, .filter-group input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .stats {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-label {
            color: #6c757d;
            font-size: 13px;
        }

        .table-container {
            overflow-x: auto;
            padding: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            border-right: 1px solid rgba(255,255,255,0.2);
            font-size: 13px;
        }

        th:last-child {
            border-right: none;
        }

        tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        td {
            padding: 12px 10px;
            vertical-align: top;
            border-right: 1px solid #e9ecef;
        }

        td:last-child {
            border-right: none;
        }

        .process-header {
            background: #e7f3ff;
            font-weight: bold;
            font-size: 14px;
            padding: 15px !important;
        }

        .control-row {
            background: white;
        }

        .control-row:hover {
            background: #fafafa;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-conforme {
            background: #d4edda;
            color: #155724;
        }

        .status-non-conforme {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        .comment-icon {
            cursor: pointer;
            color: #667eea;
            font-size: 16px;
            margin-right: 5px;
        }

        .comment-icon:hover {
            color: #5568d3;
        }

        .comment-preview {
            font-size: 11px;
            color: #6c757d;
            font-style: italic;
        }

        .process-status {
            font-weight: bold;
            font-size: 13px;
            padding: 8px 15px;
            border-radius: 6px;
            display: inline-block;
            margin-left: 15px;
        }

        .process-conforme {
            background: #d4edda;
            color: #155724;
        }

        .process-non-conforme {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: column;
                width: 100%;
            }
            
            .filter-group select, .filter-group input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Grille de Contr√¥le Op√©rationnel</h1>
            <p>Syst√®me de gestion et de suivi des contr√¥les internes</p>
            <span class="save-indicator" id="saveIndicator"></span>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="openAddProcessModal()">
                ‚ûï Nouveau Processus
            </button>
            <button class="btn btn-primary" onclick="openAddControlModal()">
                ‚ûï Nouveau Contr√¥le
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
                üì• Export Excel
            </button>
            <button class="btn btn-warning" onclick="toggleStats()">
                üìà Statistiques
            </button>
            <div class="filter-group">
                <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="filterTable()">
                <select id="filterProcessus" onchange="filterTable()">
                    <option value="">Tous les processus</option>
                </select>
                <select id="filterStatut" onchange="filterTable()">
                    <option value="">Tous les statuts</option>
                    <option value="‚úîÔ∏è">Conforme</option>
                    <option value="‚ùå">Non conforme</option>
                </select>
            </div>
        </div>

        <div class="stats" id="statsSection" style="display: none;">
            <div class="stat-card">
                <div class="stat-label">Total Processus</div>
                <div class="stat-value" id="totalProcessus">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Contr√¥les</div>
                <div class="stat-value" id="totalControles">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Contr√¥les Conformes</div>
                <div class="stat-value" style="color: #28a745;" id="conformes">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Non Conformes</div>
                <div class="stat-value" style="color: #dc3545;" id="nonConformes">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Taux de Conformit√©</div>
                <div class="stat-value" style="color: #667eea;" id="tauxConformite">0%</div>
            </div>
        </div>

        <div id="errorContainer"></div>

        <div class="table-container">
            <div id="loadingIndicator" class="loading">‚è≥ Chargement des donn√©es...</div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üìã</div>
                <h3>Aucun contr√¥le pour le moment</h3>
                <p>Commencez par cr√©er un nouveau processus ou un nouveau contr√¥le</p>
                <br>
                <button class="btn btn-primary" onclick="openAddProcessModal()">‚ûï Cr√©er un processus</button>
            </div>
            <table id="controlTable" style="display: none;">
                <thead>
                    <tr>
                        <th style="width: 180px;">Processus / Contr√¥le</th>
                        <th style="width: 200px;">Description</th>
                        <th style="width: 120px;">Responsable</th>
                        <th style="width: 100px;">Fr√©quence</th>
                        <th style="width: 100px;">Statut</th>
                        <th style="width: 100px;">Date V√©rif.</th>
                        <th style="width: 200px;">Commentaires</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Commentaire -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCommentModal()">&times;</span>
            <div class="modal-header">üí¨ Commentaire</div>
            <textarea id="commentText" placeholder="Entrez votre commentaire..."></textarea>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveComment()">Enregistrer</button>
                <button class="btn" onclick="closeCommentModal()" style="background: #6c757d; color: white;">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter Processus -->
    <div id="addProcessModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddProcessModal()">&times;</span>
            <div class="modal-header">‚ûï Nouveau Processus</div>
            <div class="form-group">
                <label>Nom du Processus *</label>
                <input type="text" id="processNom" placeholder="Ex: Cycle Achats-Fournisseurs">
            </div>
            <div class="form-group">
                <label>Responsable du Processus *</label>
                <input type="text" id="processResponsable" placeholder="Ex: Pierre Durand">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveProcess()">Cr√©er</button>
                <button class="btn" onclick="closeAddProcessModal()" style="background: #6c757d; color: white;">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter/Modifier Contr√¥le -->
    <div id="addControlModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddControlModal()">&times;</span>
            <div class="modal-header" id="controlModalTitle">‚ûï Nouveau Contr√¥le</div>
            <div class="form-group">
                <label>Processus *</label>
                <select id="controlProcessus">
                    <option value="">S√©lectionnez un processus</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nom du Contr√¥le *</label>
                <input type="text" id="controlNom" placeholder="Ex: √âmission Bon de Commande">
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="controlDescription" placeholder="Description d√©taill√©e du contr√¥le..."></textarea>
            </div>
            <div class="form-group">
                <label>Responsable *</label>
                <input type="text" id="controlResponsable" placeholder="Ex: Sophie Martin">
            </div>
            <div class="form-group">
                <label>Fr√©quence *</label>
                <select id="controlFrequence">
                    <option value="Quotidien">Quotidien</option>
                    <option value="Hebdomadaire">Hebdomadaire</option>
                    <option value="Mensuel">Mensuel</option>
                    <option value="Trimestriel">Trimestriel</option>
                    <option value="Annuel">Annuel</option>
                    <option value="Syst√©matique">Syst√©matique</option>
                    <option value="Ponctuel">Ponctuel</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveControl()">Enregistrer</button>
                <button class="btn" onclick="closeAddControlModal()" style="background: #6c757d; color: white;">Annuler</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
        
        const supabaseUrl = 'https://bcwbyugpjlwrpvbbgajg.supabase.co'
        const supabaseKey = 'sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60'
        const supabase = createClient(supabaseUrl, supabaseKey)

        let controles = []
        let processus = []
        let currentCommentId = null
        let currentEditId = null

        // Chargement initial
        async function loadData() {
            try {
                const { data, error } = await supabase
                    .from('controles')
                    .select('*')
                    .order('processus', { ascending: true })
                    .order('ordre', { ascending: true })

                if (error) throw error

                controles = data || []
                extractProcessus()
                renderTable()
                updateStats()
                updateFilterOptions()
                
                document.getElementById('loadingIndicator').style.display = 'none'
                
                if (controles.length === 0) {
                    document.getElementById('emptyState').style.display = 'block'
                } else {
                    document.getElementById('controlTable').style.display = 'table'
                }
            } catch (err) {
                console.error(err)
                showError('Impossible de charger les donn√©es. V√©rifiez la connexion Supabase.')
                document.getElementById('loadingIndicator').style.display = 'none'
            }
        }

        // Extraire la liste des processus uniques
        function extractProcessus() {
            const processusSet = new Set()
            controles.forEach(ctrl => {
                if (ctrl.processus) {
                    processusSet.add(ctrl.processus)
                }
            })
            processus = Array.from(processusSet)
        }

        // Rendu du tableau
        function renderTable() {
            const tbody = document.getElementById('tableBody')
            tbody.innerHTML = ''
            
            let currentProcess = ''
            
            controles.forEach((ctrl, index) => {
                if (ctrl.processus !== currentProcess) {
                    currentProcess = ctrl.processus
                    const headerRow = document.createElement('tr')
                    headerRow.className = 'process-header'
                    headerRow.dataset.processus = currentProcess
                    
                    const processControls = controles.filter(c => c.processus === currentProcess)
                    const conformeCount = processControls.filter(c => c.statut === '‚úîÔ∏è').length
                    const totalCount = processControls.length
                    const allConforme = conformeCount === totalCount && totalCount > 0
                    
                    const statusClass = allConforme ? 'process-conforme' : 'process-non-conforme'
                    const statusText = allConforme ? '‚úîÔ∏è Processus Conforme' : '‚ùå Processus Non Conforme'
                    
                    headerRow.innerHTML = `
                        <td colspan="8">
                            <strong>${currentProcess}</strong> - Responsable: ${ctrl.responsable || 'Non d√©fini'}
                            <span class="process-status ${statusClass}">${statusText}</span>
                            <button class="btn btn-danger btn-sm" style="float: right;" onclick="window.deleteProcess('${currentProcess}')">üóëÔ∏è Supprimer processus</button>
                        </td>
                    `
                    tbody.appendChild(headerRow)
                }

                const row = document.createElement('tr')
                row.className = 'control-row'
                row.dataset.id = ctrl.id
                row.dataset.processus = ctrl.processus
                row.dataset.statut = ctrl.statut

                const isConforme = ctrl.statut === '‚úîÔ∏è'
                const statusClass = isConforme ? 'status-conforme' : 'status-non-conforme'
                const commentPreview = ctrl.commentaire 
                    ? (ctrl.commentaire.length > 40 ? ctrl.commentaire.substring(0, 40) + '...' : ctrl.commentaire)
                    : ''

                row.innerHTML = `
                    <td><strong>${ctrl.controle || 'Sans nom'}</strong></td>
                    <td>${ctrl.description || ''}</td>
                    <td>${ctrl.responsable || ''}</td>
                    <td>${ctrl.frequence || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}" onclick="window.toggleStatus('${ctrl.id}')">${ctrl.statut}</span></td>
                    <td onclick="window.updateDate('${ctrl.id}')" style="cursor: pointer;">${ctrl.date_verification || 'N/A'}</td>
                    <td>
                        <span class="comment-icon" onclick="window.openCommentModal('${ctrl.id}')">üí¨</span>
                        <span class="comment-preview">${commentPreview}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="window.editControl('${ctrl.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="window.deleteControl('${ctrl.id}')">üóëÔ∏è</button>
                        </div>
                    </td>
                `
                tbody.appendChild(row)
            })
        }

        // Sauvegarder un contr√¥le
        async function saveControle(ctrl) {
            showSaveIndicator('saving')
            try {
                const { error } = await supabase
                    .from('controles')
                    .update({
                        statut: ctrl.statut,
                        commentaire: ctrl.commentaire,
                        date_verification: ctrl.date_verification,
                        controle: ctrl.controle,
                        description: ctrl.description,
                        responsable: ctrl.responsable,
                        frequence: ctrl.frequence,
                        processus: ctrl.processus
                    })
                    .eq('id', ctrl.id)

                if (error) throw error
                showSaveIndicator('saved')
            } catch (err) {
                console.error(err)
                showSaveIndicator('error')
            }
        }

        // Toggle statut
        window.toggleStatus = async function(id) {
            const ctrl = controles.find(c => c.id === id)
            if (!ctrl) return
            
            ctrl.statut = ctrl.statut === '‚ùå' ? '‚úîÔ∏è' : '‚ùå'
            await saveControle(ctrl)
            renderTable()
            updateStats()
        }

        // Mettre √† jour la date
        window.updateDate = async function(id) {
            const ctrl = controles.find(c => c.id === id)
            if (!ctrl) return
            
            const today = new Date().toISOString().split('T')[0]
            ctrl.date_verification = today
            await saveControle(ctrl)
            renderTable()
        }

        // Ouvrir modal commentaire
        window.openCommentModal = function(id) {
            currentCommentId = id
            const ctrl = controles.find(c => c.id === id)
            document.getElementById('commentText').value = ctrl?.commentaire || ''
            document.getElementById('commentModal').style.display = 'block'
        }

        // Fermer modal commentaire
        window.closeCommentModal = function() {
            document.getElementById('commentModal').style.display = 'none'
            currentCommentId = null
        }

        // Sauvegarder commentaire
        window.saveComment = async function() {
            if (!currentCommentId) return
            
            const ctrl = controles.find(c => c.id === currentCommentId)
            if (!ctrl) return
            
            ctrl.commentaire = document.getElementById('commentText').value
            await saveControle(ctrl)
            renderTable()
            closeCommentModal()
        }

        // Ouvrir modal ajout processus
        window.openAddProcessModal = function() {
            document.getElementById('processNom').value = ''
            document.getElementById('processResponsable').value = ''
            document.getElementById('addProcessModal').style.display = 'block'
        }

        // Fermer modal ajout processus
        window.closeAddProcessModal = function() {
            document.getElementById('addProcessModal').style.display = 'none'
        }

        // Sauvegarder processus
        window.saveProcess = async function() {
            const nom = document.getElementById('processNom').value.trim()
            const responsable = document.getElementById('processResponsable').value.trim()

            if (!nom || !responsable) {
                alert('Veuillez remplir tous les champs obligatoires')
                return
            }

            showSaveIndicator('saving')
            try {
                const { error } = await supabase
                    .from('controles')
                    .insert({
                        processus: nom,
                        controle: 'Nouveau contr√¥le',
                        description: '√Ä compl√©ter',
                        responsable: responsable,
                        frequence: 'Mensuel',
                        statut: '‚ùå',
                        commentaire: '',
                        date_verification: new Date().toISOString().split('T')[0],
                        ordre: controles.length + 1
                    })

                if (error) throw error

                showSaveIndicator('saved')
                closeAddProcessModal()
                await loadData()
            } catch (err) {
                console.error(err)
                showSaveIndicator('error')
                showError('Erreur lors de la cr√©ation du processus')
            }
        }

        // Ouvrir modal ajout/modification contr√¥le
        window.openAddControlModal = function() {
            currentEditId = null
            document.getElementById('controlModalTitle').textContent = '‚ûï Nouveau Contr√¥le'
            document.getElementById('controlProcessus').innerHTML = '<option value="">S√©lectionnez un processus</option>'
            
            processus.forEach(proc => {
                const option = document.createElement('option')
                option.value = proc
                option.textContent = proc
                document.getElementById('controlProcessus').appendChild(option)
            })

            document.getElementById('controlProcessus').value = ''
            document.getElementById('controlNom').value = ''
            document.getElementById('controlDescription').value = ''
            document.getElementById('controlResponsable').value = ''
            document.getElementById('controlFrequence').value = 'Mensuel'
            
            document.getElementById('addControlModal').style.display = 'block'
        }

        // Fermer modal ajout contr√¥le
        window.closeAddControlModal = function() {
            document.getElementById('addControlModal').style.display = 'none'
            currentEditId = null
        }

        // √âditer un contr√¥le
        window.editControl = function(id) {
            const ctrl = controles.find(c => c.id === id)
            if (!ctrl) return

            currentEditId = id
            document.getElementById('controlModalTitle').textContent = '‚úèÔ∏è Modifier le Contr√¥le'
            
            document.getElementById('controlProcessus').innerHTML = '<option value="">S√©lectionnez un processus</option>'
            processus.forEach(proc => {
                const option = document.createElement('option')
                option.value = proc
                option.textContent = proc
                document.getElementById('controlProcessus').appendChild(option)
            })

            document.getElementById('controlProcessus').value = ctrl.
