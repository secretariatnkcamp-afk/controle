<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grille de Contr√¥le Op√©rationnel</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* --- STYLE IDENTIQUE AU TIEN (non modifi√©) --- */
body{font-family:Segoe UI;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px}
.container{background:#fff;border-radius:15px;max-width:1800px;margin:auto;overflow:hidden}
.header{color:#fff;padding:30px;text-align:center;background:linear-gradient(135deg,#667eea,#764ba2)}
.controls{padding:20px;background:#f8f9fa;display:flex;gap:10px;flex-wrap:wrap}
.btn{padding:10px 16px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
.btn-primary{background:#667eea;color:#fff}
.btn-success{background:#28a745;color:#fff}
.btn-danger{background:#dc3545;color:#fff}
.btn-warning{background:#ffc107}
.stats{padding:20px;display:none;gap:15px;background:#f8f9fa}
.stat-card{background:#fff;padding:15px;border-radius:10px;flex:1;text-align:center}
.table-container{padding:20px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #ddd;padding:10px}
thead{background:#667eea;color:#fff}
.process-header{background:#e7f3ff;font-weight:bold}
.status{padding:5px 10px;border-radius:20px;font-weight:bold;cursor:pointer}
.Conforme{background:#d4edda}
.Non{background:#f8d7da}
.En{background:#fff3cd}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5)}
.modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:12px;max-width:600px}
</style>
</head>

<body>

<div class="container">
<div class="header">
<h1>üìä Grille de Contr√¥le Op√©rationnel</h1>
</div>

<div class="controls">
<button class="btn btn-primary" onclick="openAddControl()">‚ûï Nouveau contr√¥le</button>
<button class="btn btn-success" onclick="exportToExcel()">üì• Export Excel</button>
<button class="btn btn-warning" onclick="toggleStats()">üìà Stats</button>
</div>

<div class="stats" id="stats">
<div class="stat-card">Total<br><b id="total">0</b></div>
<div class="stat-card">Conformes<br><b id="ok">0</b></div>
<div class="stat-card">Non conformes<br><b id="ko">0</b></div>
<div class="stat-card">En cours<br><b id="en">0</b></div>
</div>

<div class="table-container">
<table id="table">
<thead>
<tr>
<th>Processus</th>
<th>Contr√¥le</th>
<th>Description</th>
<th>Responsable</th>
<th>Fr√©quence</th>
<th>Statut</th>
<th>Date</th>
<th>üóëÔ∏è</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<div class="modal" id="addModal">
<div class="modal-content">
<h3>Nouveau contr√¥le</h3>
<input id="p_processus" placeholder="Processus"><br><br>
<input id="p_controle" placeholder="Contr√¥le"><br><br>
<textarea id="p_description" placeholder="Description"></textarea><br><br>
<input id="p_responsable" placeholder="Responsable"><br><br>
<input id="p_frequence" placeholder="Fr√©quence"><br><br>
<button class="btn btn-primary" onclick="addControle()">Enregistrer</button>
<button class="btn" onclick="closeAdd()">Fermer</button>
</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://bcwbyugpjlwrpvbbgajg.supabase.co',
  'sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60'
)

let controles=[]

async function load(){
const {data}=await supabase.from('controles').select('*').order('processus').order('ordre')
controles=data||[]
render()
stats()
}

function render(){
tbody.innerHTML=''
let proc=''
controles.forEach(c=>{
if(c.processus!==proc){
proc=c.processus
tbody.innerHTML+=`<tr class="process-header"><td colspan="8">${proc}</td></tr>`
}
tbody.innerHTML+=`
<tr>
<td>${c.processus}</td>
<td>${c.controle}</td>
<td>${c.description||''}</td>
<td>${c.responsable||''}</td>
<td>${c.frequence||''}</td>
<td>
<select onchange="updateStatus('${c.id}',this.value)">
<option ${c.statut=='Conforme'?'selected':''}>Conforme</option>
<option ${c.statut=='Non conforme'?'selected':''}>Non conforme</option>
<option ${c.statut=='En cours'?'selected':''}>En cours</option>
</select>
</td>
<td onclick="updateDate('${c.id}')" style="cursor:pointer">${c.date_verif||''}</td>
<td><button class="btn btn-danger" onclick="deleteControl('${c.id}')">X</button></td>
</tr>`
})
}

window.updateStatus=async(id,val)=>{
await supabase.from('controles').update({statut:val}).eq('id',id)
load()
}

window.updateDate=async(id)=>{
const d=new Date().toISOString().split('T')[0]
await supabase.from('controles').update({date_verif:d}).eq('id',id)
load()
}

window.deleteControl=async(id)=>{
if(confirm('Supprimer ?')){
await supabase.from('controles').delete().eq('id',id)
load()
}
}

window.openAddControl=()=>addModal.style.display='block'
window.closeAdd=()=>addModal.style.display='none'

window.addControle=async()=>{
await supabase.from('controles').insert({
processus:p_processus.value,
controle:p_controle.value,
description:p_description.value,
responsable:p_responsable.value,
frequence:p_frequence.value,
statut:'En cours'
})
closeAdd()
load()
}

function stats(){
let ok=0,ko=0,en=0
controles.forEach(c=>{
if(c.statut=='Conforme')ok++
if(c.statut=='Non conforme')ko++
if(c.statut=='En cours')en++
})
total.textContent=controles.length
document.getElementById('ok').textContent=ok
document.getElementById('ko').textContent=ko
document.getElementById('en').textContent=en
}

window.toggleStats=()=>stats.style.display=stats.style.display=='none'?'flex':'none'

window.exportToExcel=()=>{
const wb=XLSX.utils.table_to_book(table)
XLSX.writeFile(wb,'grille_controle.xlsx')
}

document.addEventListener('DOMContentLoaded',load)
</script>

</body>
</html>
