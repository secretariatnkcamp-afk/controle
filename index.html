<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grille de ContrÃ´le OpÃ©rationnel</title>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
window.supabase = createClient(
  'https://bcwbyugpjlwrpvbbgajg.supabase.co',
  'sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60'
)
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Segoe UI;background:#f4f6fb;padding:20px}
.container{background:#fff;border-radius:14px;box-shadow:0 15px 40px rgba(0,0,0,.2);overflow:hidden}
header{background:#667eea;color:#fff;padding:25px;text-align:center}
.controls{padding:15px;display:flex;gap:10px;flex-wrap:wrap}
button{padding:10px 16px;border:none;border-radius:8px;background:#667eea;color:#fff;font-weight:600;cursor:pointer}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:10px;vertical-align:top}
th{background:#667eea;color:#fff}
.process-row{background:#e8efff;font-weight:bold}
.editable{cursor:pointer}
select{padding:6px;border-radius:6px}
.status-Conforme{background:#d4edda}
.status-Non\ conforme{background:#f8d7da}
.status-En\ cours{background:#fff3cd}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5)}
.modal-content{background:#fff;margin:10% auto;padding:20px;border-radius:12px;max-width:500px}
textarea,input{width:100%;padding:8px;margin-top:8px}
.stats{display:flex;gap:15px;padding:15px;background:#f8f9fa}
.stat{background:#fff;padding:15px;border-radius:10px;flex:1;text-align:center}
</style>
</head>

<body>

<div class="container">
<header>
<h2>ðŸ“Š Grille de ContrÃ´le OpÃ©rationnel</h2>
<p>CrÃ©ation et suivi dynamique</p>
</header>

<div class="controls">
<button onclick="openAddModal()">âž• Ajouter un contrÃ´le</button>
<button onclick="exportExcel()">ðŸ“¥ Export Excel</button>
</div>

<div class="stats">
<div class="stat">Total<br><b id="total">0</b></div>
<div class="stat">Conformes<br><b id="ok">0</b></div>
<div class="stat">Non conformes<br><b id="ko">0</b></div>
<div class="stat">En cours<br><b id="encours">0</b></div>
</div>

<table id="table">
<thead>
<tr>
<th>Processus</th>
<th>ContrÃ´le</th>
<th>Description</th>
<th>Responsable</th>
<th>FrÃ©quence</th>
<th>Statut</th>
<th>Date</th>
<th>ðŸ’¬</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- MODAL AJOUT -->
<div class="modal" id="addModal">
<div class="modal-content">
<h3>Nouveau contrÃ´le</h3>
<input id="p_processus" placeholder="Processus">
<input id="p_controle" placeholder="Nom du contrÃ´le">
<textarea id="p_description" placeholder="Description"></textarea>
<input id="p_responsable" placeholder="Responsable">
<input id="p_frequence" placeholder="FrÃ©quence">
<button onclick="addControle()">Enregistrer</button>
<button onclick="closeAddModal()">Fermer</button>
</div>
</div>

<!-- MODAL COMMENTAIRE -->
<div class="modal" id="commentModal">
<div class="modal-content">
<h3>Commentaire</h3>
<textarea id="commentText"></textarea>
<button onclick="saveComment()">Sauvegarder</button>
<button onclick="closeComment()">Fermer</button>
</div>
</div>

<script type="module">
let controles=[],currentId=null

async function load(){
const {data}=await supabase.from('controles').select('*').order('processus')
controles=data||[]
render()
stats()
}

function render(){
const tb=document.getElementById('tbody')
tb.innerHTML=''
let proc=''
controles.forEach(c=>{
if(c.processus!==proc){
proc=c.processus
tb.innerHTML+=`<tr class="process-row"><td colspan="8">${proc}</td></tr>`
}
tb.innerHTML+=`
<tr>
<td class="editable" ondblclick="edit(this,'processus','${c.id}')">${c.processus}</td>
<td class="editable" ondblclick="edit(this,'controle','${c.id}')">${c.controle}</td>
<td class="editable" ondblclick="edit(this,'description','${c.id}')">${c.description||''}</td>
<td class="editable" ondblclick="edit(this,'responsable','${c.id}')">${c.responsable||''}</td>
<td class="editable" ondblclick="edit(this,'frequence','${c.id}')">${c.frequence||''}</td>
<td>
<select onchange="updateStatus('${c.id}',this.value)" class="status-${c.statut}">
<option ${c.statut=='Conforme'?'selected':''}>Conforme</option>
<option ${c.statut=='Non conforme'?'selected':''}>Non conforme</option>
<option ${c.statut=='En cours'?'selected':''}>En cours</option>
</select>
</td>
<td class="editable" ondblclick="edit(this,'date_verif','${c.id}')">${c.date_verif||''}</td>
<td><button onclick="openComment('${c.id}')">ðŸ’¬</button></td>
</tr>`
})
}

window.edit=(cell,col,id)=>{
const val=cell.textContent
cell.innerHTML=`<input value="${val}" onblur="save('${id}','${col}',this.value)">`
cell.firstChild.focus()
}

window.save=async(id,col,val)=>{
await supabase.from('controles').update({[col]:val}).eq('id',id)
load()
}

window.updateStatus=async(id,val)=>{
await supabase.from('controles').update({statut:val}).eq('id',id)
load()
}

window.openAddModal=()=>document.getElementById('addModal').style.display='block'
window.closeAddModal=()=>document.getElementById('addModal').style.display='none'

window.addControle=async()=>{
await supabase.from('controles').insert({
processus:p_processus.value,
controle:p_controle.value,
description:p_description.value,
responsable:p_responsable.value,
frequence:p_frequence.value,
statut:'En cours'
})
closeAddModal()
load()
}

window.openComment=id=>{
currentId=id
document.getElementById('commentModal').style.display='block'
}

window.saveComment=async()=>{
await supabase.from('controles').update({commentaire:commentText.value}).eq('id',currentId)
closeComment()
}

window.closeComment=()=>document.getElementById('commentModal').style.display='none'

function stats(){
let ok=0,ko=0,en=0
controles.forEach(c=>{
if(c.statut=='Conforme')ok++
if(c.statut=='Non conforme')ko++
if(c.statut=='En cours')en++
})
total.textContent=controles.length
document.getElementById('ok').textContent=ok
document.getElementById('ko').textContent=ko
document.getElementById('encours').textContent=en
}

window.exportExcel=()=>{
const wb=XLSX.utils.table_to_book(document.getElementById('table'))
XLSX.writeFile(wb,'grille_controle.xlsx')
}

document.addEventListener('DOMContentLoaded',load)
</script>
</body>
</html>
