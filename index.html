<!DOCTYPE html>
<html>
<head>
    <title>Grille Contr√¥le</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #4CAF50; color: white; }
        .statut { cursor: pointer; padding: 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üìä Grille de Contr√¥le</h1>
    
    <button onclick="charger()">üîÑ CHARGER</button>
    <button onclick="ajouter()">‚ûï AJOUTER</button>
    <button onclick="supprimer()">üóëÔ∏è SUPPRIMER</button>
    
    <div id="message" style="margin: 10px 0; padding: 10px;"></div>
    
    <table border="1">
        <thead>
            <tr>
                <th>Processus</th>
                <th>Contr√¥le</th>
                <th>Responsable</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <script>
        // VARIABLES GLOBALES
        let mesDonnees = [];
        
        // FONCTION CHARGER
        async function charger() {
            console.log("CHARGEMENT...");
            document.getElementById('message').innerHTML = "Chargement...";
            document.getElementById('message').style.background = "#ffffcc";
            
            try {
                // Appel DIRECT √† l'API Supabase sans biblioth√®que
                const response = await fetch(
                    'https://bcwbyugpjlwrpvbbgajg.supabase.co/rest/v1/controles?select=*',
                    {
                        headers: {
                            'apikey': 'sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60',
                            'Authorization': 'Bearer sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60'
                        }
                    }
                );
                
                const data = await response.json();
                console.log("DONNEES RECUES:", data);
                mesDonnees = data;
                
                // Afficher
                afficher(data);
                document.getElementById('message').innerHTML = data.length + " contr√¥le(s) charg√©(s)";
                document.getElementById('message').style.background = "#d4edda";
                
            } catch (error) {
                console.error("ERREUR:", error);
                document.getElementById('message').innerHTML = "Erreur: " + error.message;
                document.getElementById('message').style.background = "#f8d7da";
            }
        }
        
        // FONCTION AFFICHER
        function afficher(donnees) {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';
            
            donnees.forEach(item => {
                const tr = document.createElement('tr');
                
                // Couleur selon statut
                let couleur = "#f8d7da"; // rouge
                if (item.statut === '‚úîÔ∏è') couleur = "#d4edda"; // vert
                else if (item.statut === '‚Ä¶') couleur = "#fff3cd"; // orange
                
                tr.innerHTML = `
                    <td>${item.processus || ''}</td>
                    <td><strong>${item.controle || ''}</strong></td>
                    <td>${item.responsable || ''}</td>
                    <td class="statut" style="background:${couleur}" onclick="changerStatut('${item.id}')">
                        ${item.statut || '‚ùå'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // FONCTION CHANGER STATUT
        async function changerStatut(id) {
            console.log("Changer statut pour:", id);
            
            const item = mesDonnees.find(d => d.id === id);
            if (!item) return;
            
            // Nouveau statut
            let nouveauStatut = '‚ùå';
            if (item.statut === '‚ùå' || !item.statut) nouveauStatut = '‚Ä¶';
            else if (item.statut === '‚Ä¶') nouveauStatut = '‚úîÔ∏è';
            
            try {
                // Mettre √† jour via API
                const response = await fetch(
                    `https://bcwbyugpjlwrpvbbgajg.supabase.co/rest/v1/controles?id=eq.${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': 'sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60',
                            'Authorization': 'Bearer sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60',
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ statut: nouveauStatut })
                    }
                );
                
                if (response.ok) {
                    // Recharger
                    await charger();
                    document.getElementById('message').innerHTML = "Statut mis √† jour!";
                    document.getElementById('message').style.background = "#d4edda";
                }
                
            } catch (error) {
                console.error("Erreur:", error);
                document.getElementById('message').innerHTML = "Erreur: " + error.message;
                document.getElementById('message').style.background = "#f8d7da";
            }
        }
        
        // FONCTION AJOUTER
        async function ajouter() {
            const processus = prompt("Nom du processus:");
            if (!processus) return;
            
            const controle = prompt("Nom du contr√¥le:");
            if (!controle) return;
            
            const responsable = prompt("Responsable:");
            if (!responsable) return;
            
            const nouveau = {
                id: 'ctrl-' + Date.now(),
                processus: processus,
                controle: controle,
                responsable: responsable,
                statut: '‚ùå',
                frequence: 'Mensuel'
            };
            
            try {
                const response = await fetch(
                    'https://bcwbyugpjlwrpvbbgajg.supabase.co/rest/v1/controles',
                    {
                        method: 'POST',
                        headers: {
                            'apikey': 'sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60',
                            'Authorization': 'Bearer sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60',
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify([nouveau])
                    }
                );
                
                if (response.ok) {
                    await charger();
                    document.getElementById('message').innerHTML = "Contr√¥le ajout√©!";
                    document.getElementById('message').style.background = "#d4edda";
                }
                
            } catch (error) {
                console.error("Erreur:", error);
                document.getElementById('message').innerHTML = "Erreur: " + error.message;
                document.getElementById('message').style.background = "#f8d7da";
            }
        }
        
        // FONCTION SUPPRIMER
        async function supprimer() {
            const id = prompt("ID du contr√¥le √† supprimer (regardez dans la console):");
            if (!id) return;
            
            if (!confirm("Vraiment supprimer le contr√¥le " + id + " ?")) return;
            
            try {
                const response = await fetch(
                    `https://bcwbyugpjlwrpvbbgajg.supabase.co/rest/v1/controles?id=eq.${id}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'apikey': 'sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60',
                            'Authorization': 'Bearer sb_publishable_mTp8gGCiA3fd8W83gWSb5w_3OjJMU60'
                        }
                    }
                );
                
                if (response.ok) {
                    await charger();
                    document.getElementById('message').innerHTML = "Contr√¥le supprim√©!";
                    document.getElementById('message').style.background = "#d4edda";
                }
                
            } catch (error) {
                console.error("Erreur:", error);
                document.getElementById('message').innerHTML = "Erreur: " + error.message;
                document.getElementById('message').style.background = "#f8d7da";
            }
        }
        
        // Charger au d√©marrage
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page pr√™te!");
            // charger(); // D√©commentez pour charger automatiquement
        });
    </script>
</body>
</html>
